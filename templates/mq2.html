<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQ-2 Dashboard</title>
    
    <!-- Carrega Tailwind CSS para um estilo moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#0f172a',       /* Fundo Principal Escuro (slate-900) */
                        'card': '#1e293b',          /* Fundo do Card (slate-800) */
                        'accent': '#3b82f6',        /* Azul (Destaque Principal) */
                        'success': '#10b981',       /* Verde Esmeralda (Valores) */
                        'warning': '#f59e0b',       /* Amarelo (M√©dio) */
                        'danger': '#ef4444',        /* Vermelho (Alto) */
                        'text-light': '#f1f5f9',    /* Texto Principal (slate-100) */
                        'text-subtle': '#94a3b8',   /* Texto Secund√°rio (slate-400) */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Configura√ß√£o global para gr√°ficos Chart.js em tema escuro */
        canvas {
            background-color: transparent !important; /* Garante que o fundo do Chart.js seja transparente */
            max-height: 350px; 
            width: 100% !important;
            height: auto !important;
        }
        /* Ajuste do T√≠tulo para melhor legibilidade */
        .card-header {
            border-bottom: 1px solid theme('colors.slate.700');
        }
    </style>
    <script>
        // Configura√ß√£o global para gr√°ficos Chart.js
        Chart.defaults.color = 'rgb(241 245 249)'; // text-light
        Chart.defaults.borderColor = 'rgb(51 65 85)'; // slate-700
    </script>
</head>

<body class="bg-primary min-h-screen p-4 md:p-8 font-sans antialiased">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-extrabold text-accent text-center mb-8 tracking-tight flex items-center justify-center">
            <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            MQ-2 ‚Äì Monitoramento em Tempo Real
        </h1>

        <div class="bg-card rounded-xl shadow-2xl p-4 md:p-8 space-y-8 border border-slate-700">
            
            <!-- SE√á√ÉO DE M√âTRICAS PRINCIPAIS -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-4 card-header">
                
                <!-- √öltimo Valor -->
                <div class="p-4 bg-slate-800 rounded-lg shadow-inner border border-slate-700">
                    <div class="text-sm font-medium text-text-subtle uppercase">√öltimo Valor de G√°s (PPM)</div>
                    <div id="lastValue" class="text-5xl font-extrabold text-success mt-1 tracking-wider">
                        carregando...
                    </div>
                </div>

                <!-- Hor√°rio da Leitura -->
                <div class="p-4 bg-slate-800 rounded-lg shadow-inner border border-slate-700">
                    <div class="text-sm font-medium text-text-subtle uppercase">Hor√°rio da √öltima Leitura</div>
                    <div id="time" class="text-3xl font-bold text-text-light mt-2">
                        carregando...
                    </div>
                </div>
            </div>

            <!-- HIST√ìRICO RECENTE -->
            <div>
                <h2 class="text-xl font-semibold text-text-light mb-4">Hist√≥rico Recente</h2>
                <div id="history-box" class="p-4 bg-slate-700/50 rounded-lg text-sm text-text-light">
                    Carregando hist√≥rico...
                </div>
            </div>


            <!-- GR√ÅFICOS -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- Gr√°fico de Linha (Tend√™ncia) -->
                <div class="bg-slate-800 p-4 rounded-lg shadow-lg border border-slate-700">
                    <h3 class="text-lg font-semibold text-text-light mb-3 border-b border-slate-700 pb-2">üìà Gr√°fico de Linha (Tend√™ncia)</h3>
                    <canvas id="lineChart" class=""></canvas>
                </div>
                
                <!-- Gr√°fico de Barras (√öltimas Leituras) -->
                <div class="bg-slate-800 p-4 rounded-lg shadow-lg border border-slate-700">
                    <h3 class="text-lg font-semibold text-text-light mb-3 border-b border-slate-700 pb-2">üìä Gr√°fico de Barras (√öltimos 10)</h3>
                    <canvas id="barChart" class=""></canvas>
                </div>

                <!-- Gr√°fico de Pizza (Distribui√ß√£o) -->
                <div class="bg-slate-800 p-4 rounded-lg shadow-lg border border-slate-700 lg:col-span-2">
                    <h3 class="text-lg font-semibold text-text-light mb-3 border-b border-slate-700 pb-2">‚≠ï Gr√°fico de Distribui√ß√£o</h3>
                    <div class="max-w-xl mx-auto"><canvas id="pieChart"></canvas></div>
                </div>

            </div>
        </div>

        <!-- LINKS DE NAVEGA√á√ÉO -->
        <p class="text-center mt-8 space-x-4">
            <a href="{{ url_for('dashboard') }}" class="inline-flex items-center px-4 py-2 bg-slate-700 text-text-light font-medium rounded-full hover:bg-slate-600 transition duration-150">
                Voltar ao dashboard
            </a>
            <a href="{{ url_for('logout') }}" class="inline-flex items-center px-4 py-2 bg-danger text-white font-medium rounded-full hover:bg-red-600 transition duration-150">
                Sair
            </a>
        </p>
    </div>

    <script>
        let lineChart, barChart, pieChart;

        /**
         * Retorna a cor Tailwind CSS baseada no valor do g√°s.
         * @param {number} value - O valor do sensor.
         * @returns {string} - Nome da classe Tailwind.
         */
        function getColorByValue(value) {
            if (value >= 400) return 'text-danger'; // Alto
            if (value >= 200) return 'text-warning'; // M√©dio
            return 'text-success'; // Baixo
        }

        /**
         * Formata a string de timestamp ISO (ex: '2025-12-03T23:45:00Z') para exibi√ß√£o local.
         * @param {string} isoString - Timestamp ISO 8601
         * @returns {string} - Data/Hora formatada em pt-BR.
         */
        function formatTimestamp(isoString) {
            if (!isoString) return 'N/D';
            try {
                const date = new Date(isoString);
                // Retorna Data e Hora formatadas
                return date.toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                }).replace(',', ''); 
            } catch (e) {
                console.error("Erro ao formatar data:", isoString, e);
                return 'Formato Inv√°lido';
            }
        }


        async function loadLatest() {
            try {
                const res = await fetch("/api/mq2/latest");
                const json = await res.json();
                
                const lastValueEl = document.getElementById("lastValue");
                const timeEl = document.getElementById("time");

                // Limpa estilos de cor anteriores
                lastValueEl.className = 'text-5xl font-extrabold mt-1 tracking-wider'; 

                if (json.error) {
                    lastValueEl.innerText = "ERRO";
                    timeEl.innerText = json.error;
                    lastValueEl.classList.add('text-danger');
                    return;
                }
                
                const value = parseFloat(json.gas_value);
                
                // 1. Atualiza e estiliza o valor principal
                lastValueEl.innerText = isNaN(value) ? 'N/D' : value.toFixed(2) + " PPM";
                if (!isNaN(value)) {
                    lastValueEl.classList.add(getColorByValue(value));
                } else {
                    lastValueEl.classList.add('text-text-subtle');
                }
                
                // 2. Atualiza o hor√°rio formatado (usando a formata√ß√£o do JS)
                if (json.timestamp) {
                    timeEl.innerText = formatTimestamp(json.timestamp);
                } else {
                    timeEl.innerText = 'Sem hora';
                }
            } catch (error) {
                console.error("Erro ao carregar o √∫ltimo dado:", error);
                const lastValueEl = document.getElementById("lastValue");
                const timeEl = document.getElementById("time");
                lastValueEl.innerText = "FALHA";
                lastValueEl.classList.add('text-danger');
                timeEl.innerText = "Erro de Conex√£o";
            }
        }

        async function loadHistory() {
            try {
                const res = await fetch("/api/mq2/graph-data"); 
                const json = await res.json();
                
                const historyBoxEl = document.getElementById("history-box");

                if (json.error) {
                    historyBoxEl.innerHTML = `<p class="text-danger"><strong>Erro ao carregar hist√≥rico:</strong> ${json.error}</p>`;
                    return;
                }

                const labels = json.labels || []; // Timestamps ISO brutos
                const values = json.values || [];
                
                if (labels.length === 0) {
                    historyBoxEl.innerHTML = "<p class='text-text-subtle'><strong>Sem hist√≥rico:</strong> Nenhum dado dispon√≠vel no MongoDB.</p>";
                    // Destroi gr√°ficos se n√£o houver dados
                    if (lineChart) lineChart.destroy();
                    if (barChart) barChart.destroy();
                    if (pieChart) pieChart.destroy();
                    return;
                }

                // Formata todos os labels para exibi√ß√£o
                const formattedLabels = labels.map(formatTimestamp); 

                // Cria a lista de hist√≥rico (√∫ltimas 10 leituras em formato de chips)
                let html = `<strong class="text-text-light block mb-2">√öltimas ${Math.min(10, labels.length)} leituras:</strong>`;
                html += `<div class="flex flex-wrap gap-2 text-xs">`;
                
                // Mostra apenas as 10 leituras mais recentes
                const count = labels.length;
                for (let i = 1; i <= Math.min(10, count); i++) {
                    const index = count - i; 
                    const value = parseFloat(values[index]);
                    const colorClass = getColorByValue(value).replace('text-', 'bg-').replace('success', 'emerald').replace('warning', 'amber').replace('danger', 'red') + '-600';
                    
                    html += `<span class="px-3 py-1 rounded-full ${colorClass} text-white shadow-md">
                                ${formattedLabels[index].split(' ')[1]} ‚Äî ${value.toFixed(2)} PPM
                            </span>`; // Usando apenas a HORA para os chips
                }
                html += "</div>";
                historyBoxEl.innerHTML = html;

                renderCharts(formattedLabels, values); // Passa os labels formatados para os gr√°ficos
            } catch (error) {
                console.error("Erro ao carregar hist√≥rico:", error);
                document.getElementById("history-box").innerHTML = `<p class="text-danger"><strong>Erro de Conex√£o:</strong> N√£o foi poss√≠vel buscar o hist√≥rico da API.</p>`;
            }
        }

        function renderCharts(labels, values) { 
            const numericValues = values.map(d => Number(d));
            const chartColors = {
                accent: '#3b82f6',      // blue-500
                success: '#10b981',     // emerald-500
                warning: '#f59e0b',     // amber-500
                danger: '#ef4444'       // red-500
            };
            
            // Fun√ß√£o para mapear cores para cada barra/ponto
            const dynamicBackgroundColors = numericValues.map(v => {
                if (v >= 400) return chartColors.danger;
                if (v >= 200) return chartColors.warning;
                return chartColors.success;
            });

            // --- 1. Gr√°fico de Linha (Tend√™ncia) ---
            if (lineChart) lineChart.destroy();
            lineChart = new Chart(document.getElementById('lineChart'), {
                type: 'line',
                data: {
                    labels: labels, // Usando labels formatados
                    datasets: [{
                        label: 'Leituras MQ-2',
                        data: numericValues,
                        borderColor: chartColors.accent, 
                        backgroundColor: 'rgba(59, 130, 246, 0.1)', /* Sombra suave do accent */
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 1,
                        pointBackgroundColor: chartColors.accent
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: 'var(--text-subtle)' }, grid: { color: 'rgb(51 65 85)' } },
                        y: { 
                            ticks: { color: 'var(--text-subtle)' }, 
                            grid: { color: 'rgb(51 65 85)' },
                            title: { display: true, text: 'Valor (PPM)', color: 'var(--text-subtle)' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // --- 2. Gr√°fico de Barras (√öltimos 10) ---
            const last10Labels = labels.slice(-10).map(l => l.split(' ')[1]); // Pega apenas a hora
            const last10Values = numericValues.slice(-10);
            const last10Colors = dynamicBackgroundColors.slice(-10);

            if (barChart) barChart.destroy();
            barChart = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: {
                    labels: last10Labels, // Usando apenas a hora
                    datasets: [{
                        label: '√öltimas 10 Leituras',
                        data: last10Values,
                        backgroundColor: last10Colors, /* Cores din√¢micas por valor */
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: 'var(--text-subtle)' }, grid: { display: false } },
                        y: { 
                            ticks: { color: 'var(--text-subtle)' }, 
                            grid: { color: 'rgb(51 65 85)' } 
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // --- 3. Gr√°fico de Pizza (Distribui√ß√£o de N√≠veis) ---
            if (pieChart) pieChart.destroy();
            pieChart = new Chart(document.getElementById('pieChart'), {
                type: 'doughnut', 
                data: {
                    labels: ["Baixo (< 200 PPM)", "M√©dio (200-400 PPM)", "Alto (> 400 PPM)"],
                    datasets: [{
                        data: [
                            numericValues.filter(v => v < 200).length,
                            numericValues.filter(v => v >= 200 && v < 400).length,
                            numericValues.filter(v => v >= 400).length
                        ],
                        backgroundColor: [
                            chartColors.success, 
                            chartColors.warning, 
                            chartColors.danger
                        ],
                        hoverOffset: 16, 
                        borderWidth: 4,
                        borderColor: chartColors.card // Cor da borda para contraste
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: 'var(--text-light)', padding: 20 } }
                    }
                }
            });
        }

        async function refreshAll() {
            await loadLatest();
            await loadHistory();
        }

        // Inicia e configura a atualiza√ß√£o peri√≥dica
        document.addEventListener('DOMContentLoaded', () => {
             refreshAll();
             setInterval(refreshAll, 7000); // Atualiza tudo a cada 7 segundos
        });
    </script>
</body>
</html>