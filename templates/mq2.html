<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MQ-2 Dashboard (ThingSpeak)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body { background:#0f1721; color:#e6eef8; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .card { background:#1e293b; border:1px solid #334155; border-radius:12px; padding:16px; }
    canvas { width:100% !important; max-height:360px; }
  </style>
</head>
<body class="min-h-screen p-6">
  <div class="max-w-6xl mx-auto space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-3xl font-extrabold text-[#3b82f6]">MQ-2 ‚Äî Dashboard (ThingSpeak)</h1>
      <div class="text-sm text-slate-400">Fonte: ThingSpeak channel 3092047</div>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="card">
        <div class="text-sm text-slate-400 uppercase">√öltimo Valor (PPM)</div>
        <div id="lastValue" class="text-5xl font-extrabold mt-2 text-[#10b981]">carregando...</div>
      </div>
      <div class="card">
        <div class="text-sm text-slate-400 uppercase">Hor√°rio da √öltima Leitura</div>
        <div id="lastTime" class="text-2xl mt-2">carregando...</div>
      </div>
    </section>

    <section class="card">
      <h2 class="text-lg font-semibold mb-3">Hist√≥rico Recente</h2>
      <div id="historyBox" class="text-sm text-slate-200">Carregando hist√≥rico...</div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="card">
        <h3 class="font-semibold mb-2">üìà Tend√™ncia (Linha)</h3>
        <canvas id="lineChart"></canvas>
      </div>
      <div class="card">
        <h3 class="font-semibold mb-2">üìä √öltimas 10 Leituras (Barras)</h3>
        <canvas id="barChart"></canvas>
      </div>
      <div class="card lg:col-span-2">
        <h3 class="font-semibold mb-2">üç© Distribui√ß√£o (Doughnut)</h3>
        <canvas id="pieChart"></canvas>
      </div>
    </section>

    <footer class="text-sm text-slate-400 text-center">
      Atualiza a cada 7s ‚Äî consulta direta ao ThingSpeak.
    </footer>
  </div>

<script>
/* =========== CONFIG =========== */
const THINGSPEAK_CHANNEL_ID = "3092047";
const THINGSPEAK_READ_KEY = "FAAOZXTN40Q8J8M9";
const THINGSPEAK_BASE = `https://api.thingspeak.com/channels/${THINGSPEAK_CHANNEL_ID}/fields/1.json`;
const UPDATE_INTERVAL_MS = 7000;

/* Chart instances */
let lineChart = null;
let barChart = null;
let pieChart = null;

/* Helpers */
function formatTimestamp(iso) {
  if (!iso) return "‚Äî";
  try {
    const d = new Date(iso);
    return d.toLocaleString('pt-BR', { hour12:false });
  } catch { return iso; }
}
function colorByValue(v) {
  if (v >= 400) return '#ef4444';
  if (v >= 200) return '#f59e0b';
  return '#10b981';
}

/* Load latest single feed from ThingSpeak */
async function loadLatest() {
  try {
    const url = `${THINGSPEAK_BASE}?api_key=${THINGSPEAK_READ_KEY}&results=1`;
    const r = await fetch(url, {cache: "no-store"});
    const json = await r.json();
    const feed = (json.feeds && json.feeds[0]) || null;
    if (!feed || !feed.field1) {
      document.getElementById('lastValue').innerText = 'N/D';
      document.getElementById('lastTime').innerText = 'Sem dados';
      return;
    }
    const value = parseFloat(feed.field1);
    document.getElementById('lastValue').innerText = isNaN(value) ? 'N/D' : value.toFixed(2) + ' PPM';
    document.getElementById('lastValue').style.color = colorByValue(value);
    document.getElementById('lastTime').innerText = formatTimestamp(feed.created_at);
  } catch (e) {
    console.error('loadLatest err', e);
    document.getElementById('lastValue').innerText = 'ERRO';
    document.getElementById('lastTime').innerText = 'Falha ao acessar ThingSpeak';
  }
}

/* Load historical data (results count) */
async function loadHistory(results=100) {
  try {
    const url = `${THINGSPEAK_BASE}?api_key=${THINGSPEAK_READ_KEY}&results=${results}`;
    const r = await fetch(url, {cache: "no-store"});
    const json = await r.json();
    const feeds = json.feeds || [];

    // Build arrays
    const labels = [];
    const values = [];
    for (let i = 0; i < feeds.length; i++) {
      const f = feeds[i];
      if (!f.field1) continue;
      labels.push(formatTimestamp(f.created_at));
      values.push(Number(f.field1));
    }

    // Update history box (last 10)
    const historyBox = document.getElementById('historyBox');
    if (values.length === 0) {
      historyBox.innerHTML = '<div class="text-slate-400">Nenhum dado dispon√≠vel.</div>';
    } else {
      const lastN = Math.min(10, values.length);
      let html = '<ul class="space-y-1">';
      for (let i = values.length - 1; i >= values.length - lastN; i--) {
        const time = labels[i] || '‚Äî';
        const v = values[i] ?? 0;
        const color = colorByValue(v);
        html += `<li class="flex justify-between"><span class="text-slate-400">${time}</span><span style="color:${color}; font-weight:700">${v.toFixed(2)} PPM</span></li>`;
      }
      html += '</ul>';
      historyBox.innerHTML = html;
    }

    renderCharts(labels, values);
  } catch (e) {
    console.error('loadHistory err', e);
    document.getElementById('historyBox').innerHTML = '<div class="text-red-400">Erro ao carregar hist√≥rico</div>';
  }
}

/* Render charts with Chart.js */
function renderCharts(labels, values) {
  const numeric = values.map(v => Number(v) || 0);

  // Line chart
  if (lineChart) { lineChart.destroy(); lineChart = null; }
  const ctxL = document.getElementById('lineChart').getContext('2d');
  lineChart = new Chart(ctxL, {
    type: 'line',
    data: { labels, datasets: [{ label:'MQ-2 (PPM)', data: numeric, borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,0.08)', tension:0.3, pointRadius:1 }] },
    options: { responsive:true, maintainAspectRatio:false, scales:{ x:{ ticks:{ color:'#94a3b8' } }, y:{ ticks:{ color:'#94a3b8' } } }, plugins:{ legend:{ display:false } } }
  });

  // Bar chart (last 10)
  const last10Labels = labels.slice(-10).map(l => l.split(' ')[1] || l);
  const last10Values = numeric.slice(-10);
  const last10Colors = last10Values.map(v => colorByValue(v));

  if (barChart) { barChart.destroy(); barChart = null; }
  const ctxB = document.getElementById('barChart').getContext('2d');
  barChart = new Chart(ctxB, {
    type: 'bar',
    data: { labels: last10Labels, datasets: [{ label:'√öltimas 10', data: last10Values, backgroundColor: last10Colors }] },
    options: { responsive:true, maintainAspectRatio:false, scales:{ x:{ ticks:{ color:'#94a3b8' } }, y:{ ticks:{ color:'#94a3b8' } } }, plugins:{ legend:{ display:false } } }
  });

  // Pie / Doughnut distribution
  const low = numeric.filter(v => v < 200).length;
  const med = numeric.filter(v => v >= 200 && v < 400).length;
  const high = numeric.filter(v => v >= 400).length;

  if (pieChart) { pieChart.destroy(); pieChart = null; }
  const ctxP = document.getElementById('pieChart').getContext('2d');
  pieChart = new Chart(ctxP, {
    type: 'doughnut',
    data: {
      labels:['Baixo (<200)','M√©dio (200‚Äì399)','Alto (>=400)'],
      datasets:[{ data:[low,med,high], backgroundColor:['#10b981','#f59e0b','#ef4444'] }]
    },
    options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ color:'#e6eef8' } } } }
  });
}

/* Refresh loop */
async function refreshAll() {
  await loadLatest();
  await loadHistory(100);
}
document.addEventListener('DOMContentLoaded', () => {
  refreshAll();
  setInterval(refreshAll, UPDATE_INTERVAL_MS);
});
</script>
</body>
</html>
